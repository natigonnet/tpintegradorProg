<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Estad√≠sticas de Salones</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
  :root{
    --primary:#3498db;
    --green:#2ecc71;
    --amber:#f39c12;
    --red:#e74c3c;
    --ink:#222b36;
    --muted:#6b7785;
    --bg:#f5f7fb;
    --card:#ffffff;
    --edge:#e9edf2;
  }
  /* Dark mode variables (se activan en .dark) */
  .dark{
    --bg:#0f141b;
    --card:#111820;
    --edge:#212a34;
    --ink:#e6edf5;
    --muted:#a8b3c2;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--bg);
    color:var(--ink);
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial;
  }

  header{
    position:sticky; top:0; z-index:5;
    background:var(--card);
    border-bottom:1px solid var(--edge);
    box-shadow:0 2px 14px rgba(0,0,0,.06);
  }
  .bar{
    max-width:1200px; margin:0 auto; padding:14px 20px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }
  .title{font-weight:700; font-size:22px}

  .actions{display:flex; align-items:center; gap:8px}
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px;
    border:1px solid var(--edge); background:var(--card); color:var(--muted);
  }
  .btn{
    padding:9px 14px; border-radius:10px; border:1px solid var(--edge);
    background:var(--primary); color:#fff; font-weight:600; cursor:pointer;
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .btn-ghost{background:transparent; color:var(--ink)}
  .btn-ghost:hover{background:rgba(0,0,0,.05)}
  .dark .btn-ghost:hover{background:rgba(255,255,255,.06)}

  .container{max-width:1200px; margin:28px auto; padding:0 20px}

  /* KPIs */
  .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:18px}
  .card{
    background:var(--card); border:1px solid var(--edge); border-radius:14px;
    padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.04);
  }
  .k-title{color:var(--muted); font-weight:700; font-size:14px; margin-bottom:6px}
  .k-value{font-weight:800; font-size:32px}
  .t-blue{box-shadow:inset 0 4px 0 rgba(52,152,219,.35)}
  .t-green{box-shadow:inset 0 4px 0 rgba(46,204,113,.35)}
  .t-amber{box-shadow:inset 0 4px 0 rgba(243,156,18,.35)}
  .t-red{box-shadow:inset 0 4px 0 rgba(231,76,60,.35)}

  /* Charts */
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:22px}
  .chart-card{height:360px}
  .chart-card h3{font-size:20px; margin-bottom:12px}
  .chart-wrap{position:relative; height:300px} /* ‚Üê controla tama√±o */

  /* Tabla */
  .block-title{
    margin:28px 0 10px; font-family:Georgia,serif; font-weight:800; font-size:30px;
    text-align:center;
  }
  table{width:100%; border-collapse:collapse}
  thead th{
    text-transform:uppercase; letter-spacing:.06em; font-size:13px; color:var(--muted);
    background:var(--card); border-top-left-radius:8px; border-top-right-radius:8px;
  }
  th,td{padding:14px 16px; border-bottom:1px solid var(--edge)}
  tbody tr:nth-child(even){background:rgba(0,0,0,.02)}
  .dark tbody tr:nth-child(even){background:rgba(255,255,255,.03)}

  /* Administraci√≥n */
  .admin{margin-top:28px}
  .admin h2{font-family:Georgia,serif; font-size:32px; text-align:center; margin-bottom:14px}
  .admin .btn-row{display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:14px}
  .admin .btn-row .btn{min-width:260px}
  .filters{display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:12px}
  .filters label{color:var(--muted); font-weight:600}
  .filters input{
    padding:9px 10px; border:1px solid var(--edge); border-radius:8px;
    background:var(--card); color:var(--ink); width:170px;
  }
  .filters .small{width:120px}
  .result-panel{margin-top:16px; background:var(--card); border:1px solid var(--edge); border-radius:12px; padding:14px}

  /* Modal login */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:20;
  }
  .overlay.show{display:flex}
  .modal{
    background:var(--card); border:1px solid var(--edge); border-radius:16px; width:min(92vw,540px);
    padding:26px 22px 20px; box-shadow:0 24px 80px rgba(0,0,0,.35);
  }
  .modal h3{font-size:28px; text-align:center; margin-bottom:16px}
  .login-grid{display:grid; gap:12px}
  .input{
    padding:12px 14px; border:1.5px solid var(--edge); border-radius:10px; background:var(--card); color:var(--ink)
  }
  .error{color:#ff6b6b; font-size:13px; min-height:18px}

  /* small screens */
  @media (max-width:900px){
    .kpis{grid-template-columns:1fr 1fr}
    .grid-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="title">Estad√≠sticas de Salones</div>
    <div class="actions">
      <span id="adminBadge" class="pill" title="Estado de sesi√≥n">Invitado</span>
      <button id="darkToggle" class="btn-ghost pill" aria-label="Cambiar tema">üåô Modo oscuro</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- KPIs -->
  <section class="kpis">
    <div class="card t-blue">
      <div class="k-title">Total de Salones</div>
      <div id="kpiTotal" class="k-value">0</div>
    </div>
    <div class="card t-green">
      <div class="k-title">Capacidad Total</div>
      <div id="kpiCapacidad" class="k-value">0</div>
    </div>
    <div class="card t-amber">
      <div class="k-title">Ingreso Promedio</div>
      <div id="kpiPromedio" class="k-value">$0</div>
    </div>
    <div class="card t-red">
      <div class="k-title">Capacidad Promedio</div>
      <div id="kpiCapProm" class="k-value">0</div>
    </div>
  </section>

  <!-- Charts -->
  <section class="grid-2">
    <div class="card chart-card">
      <h3>Distribuci√≥n de Capacidades</h3>
      <div class="chart-wrap"><canvas id="capacidadChart"></canvas></div>
    </div>
    <div class="card chart-card">
      <h3>Distribuci√≥n de Precios</h3>
      <div class="chart-wrap"><canvas id="precioChart"></canvas></div>
    </div>
  </section>

  <!-- Tabla -->
  <h2 class="block-title">Lista de Salones</h2>
  <div class="card">
    <div class="table-wrap">
      <table id="salonesTable">
        <thead>
          <tr>
            <th>ID</th><th>T√≠tulo</th><th>Direcci√≥n</th><th>Capacidad</th><th>Importe</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Administraci√≥n -->
  <section class="card admin" id="adminSection" style="display:none">
    <h2>Administraci√≥n</h2>
    <div class="btn-row">
      <button class="btn" id="logoutBtn">Cerrar Sesi√≥n</button>
      <button class="btn" id="installBtn">Instalar/Actualizar SPs en la BD</button>
      <button class="btn" id="reporteBtn">Generar Informe de Reservas</button>
    </div>

    <div class="filters" id="reporteFiltros" style="display:none">
      <label>Fecha inicio:<input type="date" id="f_inicio"></label>
      <label>Fecha fin:<input type="date" id="f_fin"></label>
      <label>Salon ID:<input type="number" id="f_salon" class="small" min="1"></label>
      <label>Usuario ID:<input type="number" id="f_usuario" class="small" min="1"></label>
      <button class="btn" id="runReporteBtn">Ejecutar</button>
    </div>

    <div class="result-panel" id="reportePanel" style="display:none">
      <h4 style="margin-bottom:8px">Resultados del Informe</h4>
      <div id="reporteContenido">No hay datos</div>
    </div>
  </section>

</main>

<!-- Modal Login (√∫nico, sin duplicados) -->
<div id="loginOverlay" class="overlay">
  <div class="modal">
    <h3>Iniciar Sesi√≥n</h3>
    <form id="loginForm" class="login-grid" autocomplete="on">
      <input id="loginUsuario" class="input" type="text" placeholder="Usuario" required autocomplete="username"/>
      <input id="loginPassword" class="input" type="password" placeholder="Contrase√±a" required autocomplete="current-password"/>
      <button id="loginBtn" class="btn" type="submit">Ingresar</button>
      <div id="loginError" class="error"></div>
    </form>
  </div>
</div>

<script>
(() => {
  // ----------------------- Estado global -----------------------
  let salones = [];
  const charts = {cap:null, price:null};
  const qs = (s)=>document.querySelector(s);

  const els = {
    adminBadge: qs('#adminBadge'),
    adminSection: qs('#adminSection'),
    darkToggle: qs('#darkToggle'),
    kpiTotal: qs('#kpiTotal'),
    kpiCapacidad: qs('#kpiCapacidad'),
    kpiPromedio: qs('#kpiPromedio'),
    kpiCapProm: qs('#kpiCapProm'),
    tBody: qs('#salonesTable tbody'),

    // Login
    loginOverlay: qs('#loginOverlay'),
    loginForm: qs('#loginForm'),
    loginUsuario: qs('#loginUsuario'),
    loginPassword: qs('#loginPassword'),
    loginBtn: qs('#loginBtn'),
    loginError: qs('#loginError'),

    // Admin
    logoutBtn: qs('#logoutBtn'),
    installBtn: qs('#installBtn'),
    reporteBtn: qs('#reporteBtn'),
    reporteFiltros: qs('#reporteFiltros'),
    runReporteBtn: qs('#runReporteBtn'),
    reportePanel: qs('#reportePanel'),
    reporteContenido: qs('#reporteContenido'),
  };

  // ----------------------- Utilidades --------------------------
  const isDark = () => document.body.classList.contains('dark');
  const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:2}).format(Number(n||0));

  const setAdminUI = (logged) => {
    els.adminBadge.textContent = logged ? 'Admin conectado' : 'Invitado';
    els.adminBadge.style.borderColor = logged ? 'var(--green)' : 'var(--edge)';
    els.adminSection.style.display = logged ? 'block' : 'none';
  };

  const showLogin = () => els.loginOverlay.classList.add('show');
  const hideLogin = () => els.loginOverlay.classList.remove('show');

  // ------------------- Datos + KPIs + Tabla --------------------
  async function cargarDatos(){
    // Evitar doble render de charts
    if (charts.cap) { charts.cap.destroy(); charts.cap = null; }
    if (charts.price) { charts.price.destroy(); charts.price = null; }

    try{
      const resp = await fetch('/api/v1/salones');
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();
      salones = data.datos || [];

      // KPIs
      els.kpiTotal.textContent = salones.length;
      const totalCap = salones.reduce((s,x)=>s + (parseInt(x.capacidad)||0),0);
      const totalImp = salones.reduce((s,x)=>s + (parseFloat(x.importe)||0),0);
      const promImp = salones.length ? totalImp / salones.length : 0;
      const promCap = salones.length ? totalCap / salones.length : 0;
      els.kpiCapacidad.textContent = totalCap;
      els.kpiPromedio.textContent = money(promImp);
      els.kpiCapProm.textContent = Math.round(promCap);

      // Tabla
      els.tBody.innerHTML = '';
      for(const s of salones){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.salon_id}</td>
          <td>${s.titulo}</td>
          <td>${s.direccion}</td>
          <td>${s.capacidad}</td>
          <td>${money(s.importe)}</td>`;
        els.tBody.appendChild(tr);
      }

      // Gr√°ficos
      crearGraficos();

    }catch(err){
      console.error('Error al cargar datos:', err);
      alert('Error al cargar datos. Verifica la conexi√≥n.');
    }
  }

  function crearGraficos(){
    const labels = salones.map(s=>s.titulo);
    const capacidades = salones.map(s=>Number(s.capacidad||0));
    const precios = salones.map(s=>Number(s.importe||0));

    const gridColor = isDark() ? 'rgba(255,255,255,.12)' : 'rgba(0,0,0,.12)';
    const tickColor = isDark() ? '#cfd8e3' : '#425466';
    const barBg = isDark() ? 'rgba(113,166,255,.35)' : 'rgba(173,216,230,.7)';
    const barBorder = isDark() ? 'rgba(113,166,255,.8)' : 'rgba(135,206,250,.8)';
    const lineBorder = isDark() ? 'rgba(111,207,151,1)' : 'rgba(46,204,113,1)';
    const lineFill = isDark() ? 'rgba(111,207,151,.15)' : 'rgba(46,204,113,.2)';

    // Capacidad (bar)
    const ctx1 = document.getElementById('capacidadChart').getContext('2d');
    charts.cap = new Chart(ctx1,{
      type:'bar',
      data:{
        labels,
        datasets:[{label:'Capacidad', data:capacidades, backgroundColor:barBg, borderColor:barBorder, borderWidth:1}]
      },
      options:{
        maintainAspectRatio:false,
        scales:{
          y:{beginAtZero:true, grid:{color:gridColor}, ticks:{color:tickColor}},
          x:{grid:{display:false}, ticks:{color:tickColor}}
        },
        plugins:{legend:{labels:{color:tickColor}}}
      }
    });

    // Precios (line)
    const ctx2 = document.getElementById('precioChart').getContext('2d');
    charts.price = new Chart(ctx2,{
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Precio ($)', data:precios, borderColor:lineBorder, backgroundColor:lineFill,
          borderWidth:2, tension:.35, fill:true, pointRadius:4, pointHoverRadius:6
        }]
      },
      options:{
        maintainAspectRatio:false,
        scales:{
          y:{beginAtZero:true, grid:{color:gridColor}, ticks:{color:tickColor}},
          x:{grid:{display:false}, ticks:{color:tickColor}}
        },
        plugins:{legend:{labels:{color:tickColor}}}
      }
    });
  }

  // ------------------------- Login ------------------------------
  async function doLogin(e){
    e.preventDefault();
    els.loginError.textContent = '';
    els.loginBtn.disabled = true; els.loginBtn.textContent = 'Ingresando...';
    try{
      const usuario = els.loginUsuario.value.trim();
      const password = els.loginPassword.value;
      const resp = await fetch('/api/v1/admin/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({usuario, password})
      });
      if(!resp.ok){
        const err = await resp.json().catch(()=>({mensaje:'Credenciales inv√°lidas'}));
        throw new Error(err.mensaje || 'Error al iniciar sesi√≥n');
      }
      const body = await resp.json();
      localStorage.setItem('admin_token', body.token || '1'); // guardamos algo aunque tu API no devuelva token
      setAdminUI(true);
      hideLogin();
      await cargarDatos();
    }catch(err){
      els.loginError.textContent = err.message || 'Error al iniciar sesi√≥n';
    }finally{
      els.loginBtn.disabled = false; els.loginBtn.textContent = 'Ingresar';
    }
  }

  function doLogout(){
    localStorage.removeItem('admin_token');
    setAdminUI(false);
    showLogin();
  }

  // ---------------------- Admin acciones ------------------------
  els.installBtn.addEventListener('click', async ()=>{
    const token = localStorage.getItem('admin_token'); if(!token) return showLogin();
    if(!confirm('¬øInstalar/Actualizar los procedimientos almacenados en la base de datos?')) return;
    try{
      els.installBtn.disabled = true; els.installBtn.textContent = 'Instalando...';
      const r = await fetch('/api/v1/admin/instalar-sps',{method:'POST', headers:{Authorization:'Bearer '+token}});
      const data = await r.json(); if(!r.ok) throw new Error(data.mensaje||'Error desconocido');
      alert(data.mensaje || 'SPs instalados/actualizados correctamente');
    }catch(e){ alert(e.message||e); }
    finally{ els.installBtn.disabled=false; els.installBtn.textContent='Instalar/Actualizar SPs en la BD'; }
  });

  els.reporteBtn.addEventListener('click', ()=>{
    const token = localStorage.getItem('admin_token'); if(!token) return showLogin();
    els.reporteFiltros.style.display = 'flex';
    els.reportePanel.style.display = 'block';
  });

  els.runReporteBtn.addEventListener('click', async ()=>{
    const token = localStorage.getItem('admin_token'); if(!token) return showLogin();
    const params = new URLSearchParams();
    const i = qs('#f_inicio').value; const f = qs('#f_fin').value;
    const s = qs('#f_salon').value;  const u = qs('#f_usuario').value;
    if(i) params.append('fecha_inicio',i);
    if(f) params.append('fecha_fin',f);
    if(s) params.append('salon_id',s);
    if(u) params.append('usuario_id',u);

    try{
      els.runReporteBtn.disabled=true; els.runReporteBtn.textContent='Generando...';
      const r = await fetch('/api/v1/admin/reporte-reservas?'+params.toString(), {headers:{Authorization:'Bearer '+token}});
      const data = await r.json(); if(!r.ok) throw new Error(data.mensaje || 'Error generando informe');
      const rows = data.datos || [];
      if(!rows.length){ els.reporteContenido.textContent = 'No se encontraron registros.'; return; }

      // Render simple
      const keys = Object.keys(rows[0]);
      let html = '<div class="table-wrap"><table class="report-table"><thead><tr>';
      for(const k of keys){ html += `<th>${k}</th>`; }
      html += '</tr></thead><tbody>';
      for(const row of rows){
        html += '<tr>';
        for(const k of keys){
          let v = row[k];
          const kl = k.toLowerCase();
          if(v==null) v='';
          else if(kl.includes('importe')||kl.includes('total')||kl.includes('precio')) v = money(v);
          else if(kl.includes('fecha')) { try{ v = new Date(v).toISOString().slice(0,10);}catch{} }
          html += `<td>${v}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table></div>';
      els.reporteContenido.innerHTML = html;

      // CSV para descargar
      const toCsv = (val)=> `"${String(val??'').replace(/"/g,'""')}"`;
      const csvRows = [
        keys.map(k=> `"${k.replace(/"/g,'""')}"`).join(',')
      ].concat(rows.map(r=> keys.map(k=>{
        let v = r[k]; const kl = k.toLowerCase();
        if(kl.includes('importe')||kl.includes('total')||kl.includes('precio')) v = Number(v||0).toFixed(2);
        else if(kl.includes('fecha')) { try{ v = new Date(v).toISOString().slice(0,10);}catch{} }
        return toCsv(v);
      }).join(',')));
      const blob = new Blob([csvRows.join('\r\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date(); const pad = n=>String(n).padStart(2,'0');
      const fname = `informe_reservas_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.csv`;
      a.href = url; a.download = fname; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 60000);
    }catch(e){ alert(e.message||e); }
    finally{ els.runReporteBtn.disabled=false; els.runReporteBtn.textContent='Ejecutar'; }
  });

  // ------------------------ Dark mode ---------------------------
  els.darkToggle.addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    // Re-pintar gr√°ficos con paleta correcta
    crearGraficos();
    els.darkToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Modo claro' : 'üåô Modo oscuro';
  });

  // ---------------------- Eventos login ------------------------
  els.loginForm.addEventListener('submit', doLogin);
  els.logoutBtn.addEventListener('click', doLogout);

  // ------------------------ Arranque ---------------------------
  window.addEventListener('DOMContentLoaded', async () => {
    // Tema preferido
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
      document.body.classList.add('dark');
      els.darkToggle.textContent = '‚òÄÔ∏è Modo claro';
    }
    // Sesi√≥n
    const token = localStorage.getItem('admin_token');
    if (token) {
      setAdminUI(true);
      await cargarDatos();
    } else {
      setAdminUI(false);
      showLogin();
    }
  });
})();
</script>
</body>
</html>
